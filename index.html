<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ãŸã¾ã‚­ãƒ£ãƒ©ç™»å ´å›æ¤œç´¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --main-green: #4CAF50; --bg-gray: #f9f9f9; --border-color: #ddd; --accent-green: #e8f5e9; --text-color: #333; }
        body { font-family: sans-serif; line-height: 1.6; color: var(--text-color); max-width: 800px; margin: 0 auto; padding: 20px; background-color: #fff; }
        h1 { text-align: center; color: #2e7d32; border-bottom: 2px solid var(--main-green); padding-bottom: 10px; }
        
        .search-box { background: var(--bg-gray); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .filter-group { margin-bottom: 10px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        .accordion { margin-top: 15px; border: 1px solid var(--border-color); border-radius: 4px; }
        .accordion-item { border-bottom: 1px solid var(--border-color); }
        .accordion-header { background: #eee; color: var(--text-color); cursor: pointer; padding: 12px; border: none; text-align: left; font-size: 15px; font-weight: bold; width: 100%; display: block; }
        .accordion-content { padding: 0; display: none; background-color: #fff; }
        
        .group-header { font-weight: bold; padding: 8px 15px; color: #1b5e20; background-color: #f0f4f0; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; }
        .all-check { width: 20px; height: 20px; cursor: pointer; } 
        
        .char-label { display: flex; align-items: center; padding: 10px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .char-label:hover { background-color: #f9f9f9; }
        .char-label input { margin-right: 15px; width: 18px; height: 18px; }

        /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .button-area { display: flex; gap: 10px; margin: 20px 0; }
        #searchBtn { flex: 3; background-color: var(--main-green); color: white; padding: 15px; border: none; border-radius: 4px; font-size: 18px; font-weight: bold; cursor: pointer; }
        #clearBtn { flex: 1; background-color: #666; color: white; padding: 15px; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; cursor: pointer; }
        
        /* æ¤œç´¢çµæœ */
        .episode-card { border: 1px solid var(--border-color); border-left: 6px solid var(--main-green); padding: 15px; margin-bottom: 15px; border-radius: 4px; background: #fff; }
        .card-header { font-size: 0.85em; color: #666; }
        .card-title { font-size: 1.1em; font-weight: bold; margin: 5px 0; }
        .card-detail { margin-top: 10px; padding: 10px; border-top: 1px dashed #eee; font-size: 0.95em; background: #fafafa; }
        
        .user-memo-container { margin-top: 10px; padding: 10px; background: var(--accent-green); border-radius: 4px; }
        .user-memo-container textarea { width: 100%; height: 70px; border: 1px solid #fff; border-radius: 4px; padding: 8px; box-sizing: border-box; font-size: 0.9em; }

        /* ãƒ¡ãƒ¢ç®¡ç†ã‚¨ãƒªã‚¢ï¼ˆæœ€ä¸‹éƒ¨ï¼‰ */
        .admin-area { background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 40px; text-align: center; font-size: 0.85em; border: 1px solid var(--border-color); }
        .btn-small { padding: 8px 16px; margin: 5px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: #fff; }

        #backToTop { display: none; position: fixed; bottom: 25px; right: 25px; background-color: var(--main-green); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; z-index: 1000; }
    </style>
</head>
<body>

    <h1>å¿ãŸã¾ã‚­ãƒ£ãƒ©ç™»å ´å›æ¤œç´¢</h1>

    <div class="search-box">
        <input type="text" id="keyword" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚„ãƒ¡ãƒ¢ã®å†…å®¹ã§æ¤œç´¢">

        <div class="filter-group">
            <strong>åª’ä½“ï¼š</strong>
            <label><input type="radio" name="media" value="åŸä½œ" checked> åŸä½œ</label>
            <label><input type="radio" name="media" value="ã‚¢ãƒ‹ãƒ¡"> ã‚¢ãƒ‹ãƒ¡</label>
            <label><input type="radio" name="media" value="çµµæœ¬"> çµµæœ¬</label>
        </div>

        <div class="filter-group">
            <strong>ã‚ã‚‰ã™ã˜ï¼š</strong>
            <label><input type="radio" name="summary" value="ç„¡" checked> ç„¡</label>
            <label><input type="radio" name="summary" value="æœ‰"> æœ‰</label>
        </div>

        <div class="accordion" id="charAccordion"></div>
    </div>

    <div class="button-area">
        <button id="searchBtn">ã“ã®æ¡ä»¶ã§æ¤œç´¢ã™ã‚‹</button>
        <button id="clearBtn" onclick="clearAllChecks()">å…¨è§£é™¤</button>
    </div>

    <div id="result-container"></div>

    <div class="admin-area">
        <strong>ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆãƒ¡ãƒ¢ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ï¼š</strong><br>
        <button class="btn-small" onclick="exportUserMemos()">ğŸ’¾ ä¿å­˜ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰</button>
        <button class="btn-small" onclick="document.getElementById('importFile').click()">ğŸ“‚ å¾©å…ƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼‰</button>
        <input type="file" id="importFile" style="display:none" onchange="importUserMemos(event)">
    </div>

    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" id="backToTop">â†‘</button>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQE7ET0UfEFFEwYLmPCH_XGWG-6-EfJQq09tk6ItDNQXXML65uc6UJjTKJnXopzWDTkbNeWPEvN7DiE/pub?output=csv";
    let rows = [];
    let charactersByClassAndGroup = {}; 
    let userMemos = JSON.parse(localStorage.getItem('nintama_free_memos') || '{}');

    const groupSortOrder = {
        'ä¸€å¹´ç”Ÿ': ['ã¯çµ„', 'ã„çµ„', 'ã‚çµ„'], 'äºŒå¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„'], 
        'ä¸‰å¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„'], 'å››å¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„'], 
        'äº”å¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„'], 'å…­å¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„']
    };
    const classCategories = ["ä¸€å¹´ç”Ÿ", "äºŒå¹´ç”Ÿ", "ä¸‰å¹´ç”Ÿ", "å››å¹´ç”Ÿ", "äº”å¹´ç”Ÿ", "å…­å¹´ç”Ÿ", "ãã®ä¸€", "å¿è¡“å­¦åœ’é–¢ä¿‚", "ãƒ‰ã‚¯ã‚¿ã‚±åŸ", "ãƒ‰ã‚¯ãŸã¾", "ã‚¿ã‚½ã‚¬ãƒ¬ãƒ‰ã‚­åŸ", "å…µåº«æ°´è»", "ãã®ä»–"];

    // ãƒã‚§ãƒƒã‚¯ã‚’ã™ã¹ã¦å¤–ã™é–¢æ•°
    function clearAllChecks() {
        if(!confirm("é¸æŠã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã™ã¹ã¦è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        document.querySelectorAll('input[name="char"], .class-unit-check').forEach(chk => {
            chk.checked = false;
        });
    }

    function extractGroup(className) {
        if (!className) return '';
        const match = className.match(/(ã„çµ„|ã‚çµ„|ã¯çµ„)/);
        return match ? match[0] : '';
    }

    function formatVolChap(value, unit) {
        if (!value || String(value).trim() === '') return '';
        const trimmed = String(value).trim();
        return unit === 'å·»' ? `ç¬¬${trimmed}å·»` : (/^\d+$/.test(trimmed) ? `ç¬¬${trimmed}ç« ` : trimmed);
    }

    function saveMemo(id, text) {
        userMemos[id] = text;
        localStorage.setItem('nintama_free_memos', JSON.stringify(userMemos));
    }

    function exportUserMemos() {
        const blob = new Blob([JSON.stringify(userMemos, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `nintama_memo_backup.json`;
        a.click();
    }

    function importUserMemos(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                userMemos = JSON.parse(e.target.result);
                localStorage.setItem('nintama_free_memos', JSON.stringify(userMemos));
                alert('ãƒ¡ãƒ¢ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚');
            } catch (err) { alert('ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚¨ãƒ©ãƒ¼'); }
        };
        reader.readAsText(file);
    }

    async function loadData() {
        try {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
            rows = parsed.data;
            buildCharacterIndex();
            renderAccordionStructure();
            buildAccordionLists();
        } catch (error) { console.error(error); }
    }

    function buildCharacterIndex() {
        charactersByClassAndGroup = {};
        rows.forEach(r => {
            const cls = (r["ã‚­ãƒ£ãƒ©åˆ†é¡"] || "").trim(); 
            const name = (r["ã‚­ãƒ£ãƒ©å"] || "").trim();
            if (!cls || !name) return;
            const group = extractGroup(r["ã‚¯ãƒ©ã‚¹"]);
            const key = (group && groupSortOrder[cls]) ? `${cls}/${group}` : cls; 
            if (!charactersByClassAndGroup[key]) charactersByClassAndGroup[key] = new Set();
            charactersByClassAndGroup[key].add(name);
        });
    }

    function renderAccordionStructure() {
        let html = "";
        classCategories.forEach(cat => {
            html += `<div class="accordion-item">
                <button class="accordion-header">${cat}</button>
                <div class="accordion-content" id="group-${cat}"></div>
            </div>`;
        });
        document.getElementById("charAccordion").innerHTML = html;
    }
    
    function buildAccordionLists() {
        classCategories.forEach(cls => {
            const container = document.getElementById(`group-${cls}`);
            if (!container) return;
            if (groupSortOrder[cls]) {
                groupSortOrder[cls].forEach(group => {
                    const names = [...(charactersByClassAndGroup[`${cls}/${group}`] || [])].sort((a,b)=>a.localeCompare(b,'ja'));
                    if (names.length > 0) {
                        container.insertAdjacentHTML("beforeend", `<div class="group-header"><input type="checkbox" class="all-check class-unit-check"> ${cls}${group}</div>
                            <div class="class-chars">${names.map(name => `<label class="char-label"><input type="checkbox" name="char" value="${name}"> ${name}</label>`).join('')}</div>`);
                    }
                });
            } else {
                const names = [...(charactersByClassAndGroup[cls] || [])].sort((a,b)=>a.localeCompare(b,'ja'));
                container.insertAdjacentHTML("beforeend", `<div class="class-chars">${names.map(name => `<label class="char-label"><input type="checkbox" name="char" value="${name}"> ${name}</label>`).join('')}</div>`);
            }
        });

        document.querySelectorAll('.class-unit-check').forEach(chk => {
            chk.onclick = (e) => {
                const charGroup = e.target.closest('.group-header').nextElementSibling;
                charGroup.querySelectorAll('input[name="char"]').forEach(c => c.checked = e.target.checked);
                e.stopPropagation();
            };
        });
    }

    document.getElementById("searchBtn").addEventListener("click", function() {
        const keyword = document.getElementById("keyword").value.trim().toLowerCase();
        const media = document.querySelector("input[name='media']:checked").value;
        const summaryOn = document.querySelector("input[name='summary']:checked").value === "æœ‰";
        const selectedChars = [...document.querySelectorAll("input[name='char']:checked")].map(cb => cb.value);

        const episodes = new Map();
        rows.forEach(r => {
            if (r["åª’ä½“"] !== media) return;
            const id = `${r["åª’ä½“"]}-${r["å·»æ•°"]}-${r["ç« æ•°"]}-${r["ã‚¿ã‚¤ãƒˆãƒ«"]}`;
            if (!episodes.has(id)) episodes.set(id, { info: r, chars: [] });
            episodes.get(id).chars.push(r);
        });

        const resultContainer = document.getElementById("result-container");
        resultContainer.innerHTML = "";

        [...episodes.values()].forEach(ep => {
            const info = ep.info;
            const id = `${info["åª’ä½“"]}-${info["å·»æ•°"]}-${info["ç« æ•°"]}-${info["ã‚¿ã‚¤ãƒˆãƒ«"]}`;
            const episodeAllChars = ep.chars.map(c => c["ã‚­ãƒ£ãƒ©å"]);
            const currentMemo = userMemos[id] || "";

            if (selectedChars.length > 0) {
                if (!selectedChars.every(sc => episodeAllChars.includes(sc))) return;
            }
            
            if (keyword) {
                const searchTarget = `${episodeAllChars.join(" ")} ${info["ã‚¿ã‚¤ãƒˆãƒ«"]} ${info["ã‚ã‚‰ã™ã˜"]} ${currentMemo}`.toLowerCase();
                if (!searchTarget.includes(keyword)) return;
            }

            const firsts = ep.chars.filter(c => c["åˆç™»å ´å›"] === 'â—‹' || c["åˆç™»å ´å›"] === 'â–³')
                .map(c => `${c["ã‚­ãƒ£ãƒ©å"]}${c["åˆç™»å ´å›"] === 'â–³' ? '(åå‰ã®ã¿)' : ''}`);

            const volChap = `${formatVolChap(info["å·»æ•°"], 'å·»')} ${formatVolChap(info["ç« æ•°"], 'ç« ')}`.trim();
            
            resultContainer.insertAdjacentHTML("beforeend", `
                <div class="episode-card">
                    <div class="card-header">${volChap}</div>
                    <div class="card-title">${info["ã‚¿ã‚¤ãƒˆãƒ«"]}</div>
                    ${firsts.length > 0 ? `<div class="first-appearance-line" style="font-size:0.9em; font-weight:bold;">åˆç™»å ´ï¼š${firsts.join('ãƒ»')}</div>` : ''}
                    ${summaryOn ? `<div class="card-detail"><strong>ã‚ã‚‰ã™ã˜:</strong><br>${info["ã‚ã‚‰ã™ã˜"] || 'ãªã—'}</div>` : ""}
                    <div class="user-memo-container">
                        <textarea oninput="saveMemo('${id}', this.value)" placeholder="è‡ªç”±ã«ãƒ¡ãƒ¢ã‚’è¨˜å…¥">${currentMemo}</textarea>
                    </div>
                </div>
            `);
        });
        if (!resultContainer.innerHTML) resultContainer.innerHTML = "è©²å½“ãªã—";
        window.scrollTo({ top: resultContainer.offsetTop - 20, behavior: 'smooth' });
    });

    document.addEventListener("DOMContentLoaded", () => {
        loadData();
        document.getElementById("charAccordion").addEventListener("click", e => {
            const header = e.target.closest(".accordion-header");
            if (!header) return;
            const content = header.nextElementSibling;
            const isOpen = content.style.display === "block";
            document.querySelectorAll(".accordion-content").forEach(c => c.style.display = "none");
            content.style.display = isOpen ? "none" : "block";
        });
        window.addEventListener("scroll", () => {
            document.getElementById("backToTop").style.display = window.scrollY > 400 ? "block" : "none";
        });
    });
</script>
</body>
</html>
