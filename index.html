<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ãŸã¾ã‚­ãƒ£ãƒ©ç™»å ´å›æ¤œç´¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --main-green: #4CAF50; --bg-gray: #f9f9f9; --border-color: #ddd; --accent-green: #e8f5e9; --text-color: #333; }
        body { font-family: sans-serif; line-height: 1.6; color: var(--text-color); max-width: 800px; margin: 0 auto; padding: 20px; background-color: #fff; }
        h1 { text-align: center; color: #2e7d32; border-bottom: 2px solid var(--main-green); padding-bottom: 10px; }
        
        /* æ¤œç´¢ã‚¨ãƒªã‚¢ */
        .search-box { background: var(--bg-gray); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .filter-group { margin-bottom: 10px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        .accordion { margin-top: 15px; border: 1px solid var(--border-color); border-radius: 4px; }
        .accordion-item { border-bottom: 1px solid var(--border-color); }
        .accordion-header { background: #eee; color: var(--text-color); cursor: pointer; padding: 12px; border: none; text-align: left; font-size: 15px; font-weight: bold; width: 100%; display: block; }
        .accordion-content { padding: 0; display: none; background-color: #fff; }
        .group-header { font-weight: bold; padding: 8px 15px; color: #1b5e20; background-color: #f0f4f0; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; }
        .char-label { display: flex; align-items: center; padding: 10px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .char-label input { margin-right: 15px; width: 18px; height: 18px; }

        /* ãƒœã‚¿ãƒ³ */
        .button-area { display: flex; gap: 10px; margin: 20px 0; }
        #searchBtn { flex: 3; background-color: var(--main-green); color: white; padding: 15px; border: none; border-radius: 4px; font-size: 18px; font-weight: bold; cursor: pointer; }
        #clearBtn { flex: 1; background-color: #666; color: white; padding: 15px; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; cursor: pointer; }
        
        /* çµæœã‚«ãƒ¼ãƒ‰ */
        .episode-card { border: 1px solid var(--border-color); border-left: 6px solid var(--main-green); padding: 15px; margin-bottom: 15px; border-radius: 4px; background: #fff; }
        .card-title { font-size: 1.1em; font-weight: bold; margin: 5px 0; }
        .card-detail { margin-top: 10px; padding: 10px; border-top: 1px dashed #eee; font-size: 0.95em; background: #fafafa; white-space: pre-wrap; }
        .user-memo-container { margin-top: 10px; padding: 10px; background: var(--accent-green); border-radius: 4px; }
        .user-memo-container textarea { width: 100%; height: 70px; border: 1px solid #fff; border-radius: 4px; padding: 8px; box-sizing: border-box; font-family: inherit; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .footer-area { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-top: 50px; border: 1px solid var(--border-color); font-size: 0.85em; color: #555; }
        .footer-section { margin-bottom: 15px; }
        .footer-section strong { color: #2e7d32; display: block; margin-bottom: 5px; }
        .footer-section ul { padding-left: 18px; margin: 5px 0; }
        .btn-small { padding: 8px 15px; margin: 5px 2px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: #fff; font-size: 0.9em; font-weight: bold; }

        #backToTop { display: none; position: fixed; bottom: 25px; right: 25px; background-color: var(--main-green); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; z-index: 1000; font-weight: bold; }
    </style>
</head>
<body>

    <h1>å¿ãŸã¾ã‚­ãƒ£ãƒ©ç™»å ´å›æ¤œç´¢</h1>

    <div class="search-box">
        <input type="text" id="keyword" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚„ãƒ¡ãƒ¢ã®å†…å®¹ã§æ¤œç´¢">
        <div class="filter-group">
            <strong>åª’ä½“ï¼š</strong>
            <label><input type="radio" name="media" value="åŸä½œ" checked> åŸä½œ</label>
            <label><input type="radio" name="media" value="ã‚¢ãƒ‹ãƒ¡"> ã‚¢ãƒ‹ãƒ¡</label>
            <label><input type="radio" name="media" value="çµµæœ¬"> çµµæœ¬</label>
        </div>
        <div class="filter-group">
            <strong>ã‚ã‚‰ã™ã˜ï¼š</strong>
            <label><input type="radio" name="summary" value="ç„¡" checked> ç„¡</label>
            <label><input type="radio" name="summary" value="æœ‰"> æœ‰</label>
        </div>
        <div class="accordion" id="charAccordion"></div>
    </div>

    <div class="button-area">
        <button id="searchBtn">ã“ã®æ¡ä»¶ã§æ¤œç´¢ã™ã‚‹</button>
        <button id="clearBtn" onclick="clearAllChecks()">å…¨è§£é™¤</button>
    </div>

    <div id="result-container"></div>

    <footer class="footer-area">
        <div class="footer-section">
            <strong>ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆãƒ¡ãƒ¢ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</strong>
            <p>è¨˜å…¥ã—ãŸãƒ¡ãƒ¢ã¯ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ç­‰ã‚’è¡Œã†éš›ã¯ã€ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ä¿å­˜ãƒ»å¾©å…ƒã—ã¦ãã ã•ã„ã€‚</p>
            <div style="margin-top: 10px;">
                <button class="btn-small" onclick="exportUserMemos()">ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</button>
                <button class="btn-small" onclick="document.getElementById('importFile').click()">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿</button>
                <input type="file" id="importFile" style="display:none" onchange="importUserMemos(event)">
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px;">
            <a href="javascript:void(0)" id="about-link" onclick="document.getElementById('about-site-content').style.display='block'; this.style.display='none'" style="color: #999; text-decoration: none; font-size: 0.9em;">â–¶ ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦ï¼ˆä½¿ã„æ–¹ãƒ»é€£çµ¡å…ˆï¼‰</a>
            
            <div id="about-site-content" style="display:none; text-align: left; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px;">
                <div class="footer-section">
                    <strong>â–  ãƒ¡ãƒ¢æ¬„ã«ã¤ã„ã¦</strong>
                    <ul>
                        <li>è¨˜å…¥ã—ãŸãƒ¡ãƒ¢ã¯ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚</li>
                        <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚„ç«¯æœ«ã®å¤‰æ›´ã‚’è¡Œã†ã¨ãƒ¡ãƒ¢ãŒæ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ãŒã€ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ãƒ»å¾©å…ƒãŒå¯èƒ½ã§ã™ã€‚</li>
                        <li>å…¥åŠ›ã—ãŸãƒ¡ãƒ¢ãŒä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ã‚‰ã‚ŒãŸã‚Šã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                    </ul>
                </div>

                <div class="footer-section">
                    <strong>â–  æ¤œç´¢ã«ã¤ã„ã¦</strong>
                    <ul>
                        <li>è¤‡æ•°ã®æ¡ä»¶ã‚’é¸æŠã—ãŸå ´åˆã€ã™ã¹ã¦ã«ä¸€è‡´ã™ã‚‹çµæœï¼ˆANDæ¤œç´¢ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                        <li>ä¸€è¦§ã«ãªã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚„ã€è‡ªåˆ†ãŒæ›¸ã„ãŸãƒ¡ãƒ¢ã®å†…å®¹ã‚‚æ¤œç´¢çª“ã‹ã‚‰æ¢ã›ã¾ã™ã€‚</li>
                        <li>ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã£ã¦æ¤œç´¢ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</li>
                    </ul>
                </div>

                <div class="footer-section" style="border-top: 1px dashed #ccc; padding-top: 10px; color: #666;">
                    <strong>â–  ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</strong>
                    <p style="margin-bottom: 10px;">å€‹äººãŒä½œæˆã—ãŸéå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µã‚¤ãƒˆã§ã™ã€‚<br>ç‰ˆæ¨©å…ƒãƒ»é–¢ä¿‚å„ç¤¾æ§˜ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    <p>ä¿®æ­£ç‚¹ã‚„ã”æ„è¦‹ãªã©ï¼š<br>
                    Waveboxï¼š<a href="https://wavebox.me/wave/272gqicbsuqjrf0t/" target="_blank" style="color: #2e7d32; font-weight: bold;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹</a></p>
                    <p style="text-align: right; font-weight: bold; margin-top: 10px; color: #333;">ã‚µã‚¤ãƒˆç®¡ç†äººï¼šãªã«ã¬ã­ã®</p>
                    
                    <button class="btn-small" onclick="document.getElementById('about-site-content').style.display='none'; document.getElementById('about-link').style.display='inline'" style="display: block; margin: 10px auto 0; font-size: 0.8em; color: #888;">Ã— èª¬æ˜ã‚’é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </footer>

    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" id="backToTop">â†‘</button>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQE7ET0UfEFFEwYLmPCH_XGWG-6-EfJQq09tk6ItDNQXXML65uc6UJjTKJnXopzWDTkbNeWPEvN7DiE/pub?output=csv";
    let rows = [];
    let charactersByClassAndGroup = {}; 
    let userMemos = JSON.parse(localStorage.getItem('nintama_free_memos') || '{}');

    const groupSortOrder = {
        'ä¸€å¹´ç”Ÿ': ['ã¯çµ„', 'ã„çµ„', 'ã‚çµ„'], 'äºŒå¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„'], 
        'ä¸‰å¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„'], 'å››å¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„'], 
        'äº”å¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„'], 'å…­å¹´ç”Ÿ': ['ã„çµ„', 'ã‚çµ„', 'ã¯çµ„']
    };
    const classCategories = ["ä¸€å¹´ç”Ÿ", "äºŒå¹´ç”Ÿ", "ä¸‰å¹´ç”Ÿ", "å››å¹´ç”Ÿ", "äº”å¹´ç”Ÿ", "å…­å¹´ç”Ÿ", "ãã®ä¸€", "å¿è¡“å­¦åœ’é–¢ä¿‚", "ãƒ‰ã‚¯ã‚¿ã‚±åŸ", "ãƒ‰ã‚¯ãŸã¾", "ã‚¿ã‚½ã‚¬ãƒ¬ãƒ‰ã‚­åŸ", "å…µåº«æ°´è»", "ãã®ä»–"];

    function clearAllChecks() {
        if(!confirm("é¸æŠã‚’ã™ã¹ã¦è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        document.querySelectorAll('input[name="char"], .class-unit-check').forEach(chk => chk.checked = false);
    }

    function extractGroup(className) {
        if (!className) return '';
        const match = className.match(/(ã„çµ„|ã‚çµ„|ã¯çµ„)/);
        return match ? match[0] : '';
    }

    function formatVolChap(value, unit) {
        if (!value || String(value).trim() === '') return '';
        const trimmed = String(value).trim();
        return unit === 'å·»' ? `ç¬¬${trimmed}å·»` : (/^\d+$/.test(trimmed) ? `ç¬¬${trimmed}ç« ` : trimmed);
    }

    function saveMemo(id, text) {
        userMemos[id] = text;
        localStorage.setItem('nintama_free_memos', JSON.stringify(userMemos));
    }

    function exportUserMemos() {
        const blob = new Blob([JSON.stringify(userMemos, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `nintama_memo_backup.json`;
        a.click();
    }

    function importUserMemos(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                userMemos = JSON.parse(e.target.result);
                localStorage.setItem('nintama_free_memos', JSON.stringify(userMemos));
                alert('ãƒ¡ãƒ¢ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚æ¤œç´¢ã™ã‚‹ã¨åæ˜ ã•ã‚Œã¾ã™ã€‚');
            } catch (err) { alert('å½¢å¼ã‚¨ãƒ©ãƒ¼'); }
        };
        reader.readAsText(file);
    }

    async function loadData() {
        try {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
            rows = parsed.data;
            buildCharacterIndex();
            renderAccordionStructure();
            buildAccordionLists();
        } catch (error) { console.error(error); }
    }

    function buildCharacterIndex() {
        charactersByClassAndGroup = {};
        rows.forEach(r => {
            const cls = (r["ã‚­ãƒ£ãƒ©åˆ†é¡"] || "").trim(); 
            const name = (r["ã‚­ãƒ£ãƒ©å"] || "").trim();
            if (!cls || !name) return;
            const group = extractGroup(r["ã‚¯ãƒ©ã‚¹"]);
            const key = (group && groupSortOrder[cls]) ? `${cls}/${group}` : cls; 
            if (!charactersByClassAndGroup[key]) charactersByClassAndGroup[key] = new Set();
            charactersByClassAndGroup[key].add(name);
        });
    }

    function renderAccordionStructure() {
        let html = "";
        classCategories.forEach(cat => {
            html += `<div class="accordion-item">
                <button class="accordion-header">${cat}</button>
                <div class="accordion-content" id="group-${cat}"></div>
            </div>`;
        });
        document.getElementById("charAccordion").innerHTML = html;
    }
    
    function buildAccordionLists() {
        classCategories.forEach(cls => {
            const container = document.getElementById(`group-${cls}`);
            if (!container) return;
            if (groupSortOrder[cls]) {
                const displayClass = cls.replace("ç”Ÿ", ""); 
                groupSortOrder[cls].forEach(group => {
                    const names = [...(charactersByClassAndGroup[`${cls}/${group}`] || [])].sort((a,b)=>a.localeCompare(b,'ja'));
                    if (names.length > 0) {
                        container.insertAdjacentHTML("beforeend", `<div class="group-header"><input type="checkbox" class="all-check class-unit-check"> ${displayClass}${group}</div>
                            <div class="class-chars">${names.map(name => `<label class="char-label"><input type="checkbox" name="char" value="${name}"> ${name}</label>`).join('')}</div>`);
                    }
                });
            } else {
                const names = [...(charactersByClassAndGroup[cls] || [])].sort((a,b)=>a.localeCompare(b,'ja'));
                container.insertAdjacentHTML("beforeend", `<div class="class-chars">${names.map(name => `<label class="char-label"><input type="checkbox" name="char" value="${name}"> ${name}</label>`).join('')}</div>`);
            }
        });

        document.querySelectorAll('.class-unit-check').forEach(chk => {
            chk.onclick = (e) => {
                const charGroup = e.target.closest('.group-header').nextElementSibling;
                charGroup.querySelectorAll('input[name="char"]').forEach(c => c.checked = e.target.checked);
                e.stopPropagation();
            };
        });
    }

    document.getElementById("searchBtn").addEventListener("click", function() {
        const keyword = document.getElementById("keyword").value.trim().toLowerCase();
        const media = document.querySelector("input[name='media']:checked").value;
        const summaryOn = document.querySelector("input[name='summary']:checked").value === "æœ‰";
        const selectedChars = [...document.querySelectorAll("input[name='char']:checked")].map(cb => cb.value);

        const episodes = new Map();
        rows.forEach(r => {
            if (r["åª’ä½“"] !== media) return;
            const id = `${r["åª’ä½“"]}-${r["å·»æ•°"]}-${r["ç« æ•°"]}-${r["ã‚¿ã‚¤ãƒˆãƒ«"]}`;
            if (!episodes.has(id)) episodes.set(id, { info: r, chars: [] });
            episodes.get(id).chars.push(r);
        });

        const resultContainer = document.getElementById("result-container");
        resultContainer.innerHTML = "";

        [...episodes.values()].forEach(ep => {
            const info = ep.info;
            const id = `${info["åª’ä½“"]}-${info["å·»æ•°"]}-${info["ç« æ•°"]}-${info["ã‚¿ã‚¤ãƒˆãƒ«"]}`;
            const episodeAllChars = ep.chars.map(c => c["ã‚­ãƒ£ãƒ©å"]);
            const currentMemo = userMemos[id] || "";

            if (selectedChars.length > 0 && !selectedChars.every(sc => episodeAllChars.includes(sc))) return;
            if (keyword) {
                const searchTarget = `${episodeAllChars.join(" ")} ${info["ã‚¿ã‚¤ãƒˆãƒ«"]} ${info["ã‚ã‚‰ã™ã˜"]} ${currentMemo}`.toLowerCase();
                if (!searchTarget.includes(keyword)) return;
            }

            const firsts = ep.chars.filter(c => c["åˆç™»å ´å›"] === 'â—‹' || c["åˆç™»å ´å›"] === 'â–³')
                .map(c => `${c["ã‚­ãƒ£ãƒ©å"]}${c["åˆç™»å ´å›"] === 'â–³' ? '(åå‰ã®ã¿)' : ''}`);

            const volChap = `${formatVolChap(info["å·»æ•°"], 'å·»')} ${formatVolChap(info["ç« æ•°"], 'ç« ')}`.trim();
            
            resultContainer.insertAdjacentHTML("beforeend", `
                <div class="episode-card">
                    <div style="font-size:0.85em; color:#666;">${volChap}</div>
                    <div class="card-title">${info["ã‚¿ã‚¤ãƒˆãƒ«"]}</div>
                    ${firsts.length > 0 ? `<div style="font-size:0.9em; font-weight:bold; margin-bottom:5px;">åˆç™»å ´ï¼š${firsts.join('ãƒ»')}</div>` : ''}
                    ${summaryOn ? `<div class="card-detail"><strong>ã‚ã‚‰ã™ã˜:</strong><br>${info["ã‚ã‚‰ã™ã˜"] || 'ãªã—'}</div>` : ""}
                    <div class="user-memo-container">
                        <textarea oninput="saveMemo('${id}', this.value)" placeholder="è‡ªç”±ã«ãƒ¡ãƒ¢ã‚’è¨˜å…¥">${currentMemo}</textarea>
                    </div>
                </div>
            `);
        });
        if (!resultContainer.innerHTML) resultContainer.innerHTML = "è©²å½“ãªã—";
        window.scrollTo({ top: resultContainer.offsetTop - 20, behavior: 'smooth' });
    });

    document.addEventListener("DOMContentLoaded", () => {
        loadData();
        document.getElementById("charAccordion").addEventListener("click", e => {
            const header = e.target.closest(".accordion-header");
            if (!header) return;
            const content = header.nextElementSibling;
            const isOpen = content.style.display === "block";
            document.querySelectorAll(".accordion-content").forEach(c => c.style.display = "none");
            content.style.display = isOpen ? "none" : "block";
        });
        window.addEventListener("scroll", () => {
            document.getElementById("backToTop").style.display = window.scrollY > 400 ? "block" : "none";
        });
    });
</script>
</body>
</html>